import pandas as pd
import requests
import time

# --- CONFIGURATION ---
GOOGLE_API_KEY = "AIzaSyAHzrzRD81oo7CaCJtZURwEO0brIPwGi1w"

# Open Library doesn't use a key, but requires a polite User-Agent header
# REPLACE with your email so they can contact you if the script runs too fast
OPEN_LIBRARY_HEADERS = {
    'User-Agent': 'BookSearchScript/1.0 (alexandre.marlet@unil.ch)'
}

INPUT_FILE = "books_missing_isbn.csv"
OUTPUT_FILE = "books_with_found_isbn.csv"

# --- SEARCH FUNCTIONS ---

def search_google_books(title, author):
    """
    Searches Google Books. Returns ISBN-13 (preferred) or ISBN-10.
    """
    query = f"intitle:{title} inauthor:{author}"
    url = f"https://www.googleapis.com/books/v1/volumes?q={query}&key={GOOGLE_API_KEY}"
    
    try:
        response = requests.get(url)
        if response.status_code == 200:
            data = response.json()
            if "items" in data:
                book_info = data["items"][0]["volumeInfo"]
                identifiers = book_info.get("industryIdentifiers", [])
                
                # Priority: ISBN-13
                for identifier in identifiers:
                    if identifier["type"] == "ISBN_13":
                        return identifier["identifier"]
                # Fallback: ISBN-10
                for identifier in identifiers:
                    if identifier["type"] == "ISBN_10":
                        return identifier["identifier"]
    except Exception as e:
        print(f"Google Error for {title}: {e}")
    
    return None

def search_open_library(title, author):
    """
    Searches Open Library. Returns the first ISBN found in the docs.
    """
    url = "https://openlibrary.org/search.json"
    params = {
        'title': title,
        'author': author,
        'fields': 'isbn', # Only ask for ISBNs to save bandwidth
        'limit': 1        # Only get the top match
    }
    
    try:
        # Pass the headers here!
        response = requests.get(url, params=params, headers=OPEN_LIBRARY_HEADERS)
        if response.status_code == 200:
            data = response.json()
            if data.get("numFound", 0) > 0:
                # Open Library returns a list of ISBNs (strings)
                isbns = data["docs"][0].get("isbn", [])
                
                # Logic: Find the first one that looks like an ISBN-13 (starts with 978 or 979)
                for isbn in isbns:
                    if len(str(isbn)) == 13:
                        return isbn
                
                # If no 13 digit found, just return the first one available
                if isbns:
                    return isbns[0]
                    
    except Exception as e:
        print(f"OpenLibrary Error for {title}: {e}")
        
    return None

# --- MAIN EXECUTION ---

# 1. READ DATA
df = pd.read_csv(INPUT_FILE)
df['Title'] = df['Title'].astype(str)
df['Author'] = df['Author'].astype(str)

print(f"Processing {len(df)} books...")

found_count = 0
isbns = []
sources = [] # To track which API found the data

for index, row in df.iterrows():
    title_clean = row['Title'].split('/')[0].strip()
    author_clean = row['Author'].split(',')[0].strip()
    
    found_isbn = None
    source = "None"
    
    # 1. Try Google Books First
    found_isbn = search_google_books(title_clean, author_clean)
    
    if found_isbn:
        source = "Google"
    else:
        # 2. If Google fails, Try Open Library (Double Check)
        # Sleep briefly before hitting OL to respect rate limits
        time.sleep(0.5) 
        found_isbn = search_open_library(title_clean, author_clean)
        if found_isbn:
            source = "OpenLibrary"

    isbns.append(found_isbn)
    sources.append(source)
    
    if found_isbn:
        found_count += 1
        print(f"[{index+1}/{len(df)}] Found via {source}: {found_isbn}")
    else:
        print(f"[{index+1}/{len(df)}] Not found in either DB.")

    # Global rate limit pause
    time.sleep(0.5)

# 4. SAVE RESULTS
df['found_isbn'] = isbns
df['source'] = sources
df.to_csv(OUTPUT_FILE, index=False)

print(f"Done! Found {found_count} ISBNs. Saved to {OUTPUT_FILE}")